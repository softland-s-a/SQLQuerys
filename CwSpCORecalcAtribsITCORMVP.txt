ALTER Procedure CwSpCORecalcAtribsITCORMVP @TranId Varchar(10), @LPL Varchar(1), @FRA Varchar(1) as

-- Se hace en dos partes para un mejor seguimiento del stored, en caso de tener que revisar los cálculos
-- Pudo haberse hecho en una sola sentencia de update, utilizando el armado de la temporal, como tabla derivada para joinear en el update

-- Genera tabla temporal, auxiliar de la CORMVP, para rearmar la secuencia de numeracion de los atributos autonumerables
SELECT 
ITCORMVP_MODFOR, ITCORMVP_CODFOR, ITCORMVP_NROFOR, ITCORMVP_NROITM, ITCORMVP_NIVEXP, ITCORMVP_NROITD, 
ITCORMVP_MODAPL, ITCORMVP_CODAPL, ITCORMVP_NROAPL, ITCORMVP_ITMAPL, ITCORMVP_EXPAPL, ITCORMVP_ITDAPL,
ITCORMVP_TIPPRO,

/*--'#Parte->SL-97 */
/*
ROW_NUMBER() OVER(PARTITION BY ITCORMVP_TIPPRO, ITCORMVP_ARTCOD ORDER BY ITCORMVP_TIPPRO, ITCORMVP_ARTCOD, ITCORMVP_NROITM, ITCORMVP_NIVEXP, ITCORMVP_NROITD ASC) 
+ 
CASE STTTPH_NUMAUT 
			WHEN 'NSERIE' THEN
						(SELECT ISNULL(MAX(STRMVK_NSERIE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'NDESPA' THEN
						(SELECT ISNULL(MAX(STRMVK_NDESPA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'ENVASE' THEN
						(SELECT ISNULL(MAX(STRMVK_ENVASE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'NOTROS' THEN
						(SELECT ISNULL(MAX(STRMVK_NOTROS),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'NATRIB' THEN
						(SELECT ISNULL(MAX(STRMVK_NATRIB),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'NUBICA' THEN
						(SELECT ISNULL(MAX(STRMVK_NUBICA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			WHEN 'NESTAN' THEN
						(SELECT ISNULL(MAX(STRMVK_NESTAN),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
END NEWATRIB   
*/
CASE WHEN STTTPH_NUMAUT = 'C'	-- Numera por tipo y codigo de producto
		THEN 
			ROW_NUMBER() OVER(PARTITION BY ITCORMVP_TIPPRO, ITCORMVP_ARTCOD ORDER BY ITCORMVP_TIPPRO, ITCORMVP_ARTCOD, ITCORMVP_NROITM, ITCORMVP_NIVEXP, ITCORMVP_NROITD ASC) 
			+ 
			CASE STTTPH_NUMAUT 
						WHEN 'NSERIE' THEN
									(SELECT ISNULL(MAX(STRMVK_NSERIE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'NDESPA' THEN
									(SELECT ISNULL(MAX(STRMVK_NDESPA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'ENVASE' THEN
									(SELECT ISNULL(MAX(STRMVK_ENVASE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'NOTROS' THEN
									(SELECT ISNULL(MAX(STRMVK_NOTROS),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'NATRIB' THEN
									(SELECT ISNULL(MAX(STRMVK_NATRIB),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'NUBICA' THEN
									(SELECT ISNULL(MAX(STRMVK_NUBICA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
						WHEN 'NESTAN' THEN
									(SELECT ISNULL(MAX(STRMVK_NESTAN),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO AND STRMVK_ARTCOD = ITCORMVP_ARTCOD) 
			END   
		ELSE	-- Numera por tipo de producto
			ROW_NUMBER() OVER(PARTITION BY ITCORMVP_TIPPRO ORDER BY ITCORMVP_TIPPRO, ITCORMVP_ARTCOD, ITCORMVP_NROITM, ITCORMVP_NIVEXP, ITCORMVP_NROITD ASC) 
			+ 
			CASE STTTPH_NUMAUT 
						WHEN 'NSERIE' THEN
									(SELECT ISNULL(MAX(STRMVK_NSERIE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'NDESPA' THEN
									(SELECT ISNULL(MAX(STRMVK_NDESPA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'ENVASE' THEN
									(SELECT ISNULL(MAX(STRMVK_ENVASE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'NOTROS' THEN
									(SELECT ISNULL(MAX(STRMVK_NOTROS),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'NATRIB' THEN
									(SELECT ISNULL(MAX(STRMVK_NATRIB),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'NUBICA' THEN
									(SELECT ISNULL(MAX(STRMVK_NUBICA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
						WHEN 'NESTAN' THEN
									(SELECT ISNULL(MAX(STRMVK_NESTAN),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITCORMVP_TIPPRO) 
			END   			
END NEWATRIB  
/*FIN '#Parte->INFOC-369*/
INTO #ITCORMVP_AUX
FROM #ITCORMVP, STTTPH
WHERE 
ITCORMVP_TRANID = @TRANID AND 
ITCORMVP_TIPPRO = STTTPH_TIPPRO 
/*'#Parte->FDS-412*/
AND 1 = CASE WHEN @FRA = 'S' THEN
							CASE WHEN ITCORMVP_NCANPN = 'S' THEN 1 ELSE 0 END 
							ELSE 1
							END	



--- Updetea la tabla intermedia de CORMVP (ITCORMVP), con los atributos autonumerables recalculados
UPDATE P1 
SET 
P1.ITCORMVP_NSERIE = CASE WHEN STTTPH_NUMAUT = 'NSERIE' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NSERIE END,
P1.ITCORMVP_NDESPA = CASE WHEN STTTPH_NUMAUT = 'NDESPA' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NDESPA END,
P1.ITCORMVP_ENVASE = CASE WHEN STTTPH_NUMAUT = 'ENVASE' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_ENVASE END,
P1.ITCORMVP_NOTROS = CASE WHEN STTTPH_NUMAUT = 'NOTROS' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NOTROS END,
P1.ITCORMVP_NATRIB = CASE WHEN STTTPH_NUMAUT = 'NATRIB' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NATRIB END,
P1.ITCORMVP_NUBICA = CASE WHEN STTTPH_NUMAUT = 'NUBICA' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NUBICA END,
P1.ITCORMVP_NESTAN = CASE WHEN STTTPH_NUMAUT = 'NESTAN' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_NESTAN END
--'#Parte->FDS-410
,P1.ITCORMVP_TSERIE = CASE WHEN STTTPH_NUMAUT = 'NSERIE' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TSERIE END,
P1.ITCORMVP_TDESPA = CASE WHEN STTTPH_NUMAUT = 'NDESPA' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TDESPA END,
P1.ITCORMVP_TENVAS = CASE WHEN STTTPH_NUMAUT = 'ENVASE' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TENVAS END,
P1.ITCORMVP_TOTROS = CASE WHEN STTTPH_NUMAUT = 'NOTROS' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TOTROS END,
P1.ITCORMVP_TATRIB = CASE WHEN STTTPH_NUMAUT = 'NATRIB' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TATRIB END,
P1.ITCORMVP_TUBICA = CASE WHEN STTTPH_NUMAUT = 'NUBICA' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TUBICA END,
P1.ITCORMVP_TESTAN = CASE WHEN STTTPH_NUMAUT = 'NESTAN' And @LPL = 'S' THEN REPLICATE(' ',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITCORMVP_TESTAN END
/*FIN '#Parte->FDS-410*/

FROM #ITCORMVP P1, #ITCORMVP_AUX P2, STTTPH
WHERE 
P1.ITCORMVP_TRANID = @TRANID AND 
P1.ITCORMVP_TIPPRO = STTTPH_TIPPRO AND
P1.ITCORMVP_MODFOR = P2.ITCORMVP_MODFOR AND 
P1.ITCORMVP_CODFOR = P2.ITCORMVP_CODFOR AND 
P1.ITCORMVP_NROFOR = P2.ITCORMVP_NROFOR AND 
P1.ITCORMVP_NROITM = P2.ITCORMVP_NROITM AND 
P1.ITCORMVP_NIVEXP = P2.ITCORMVP_NIVEXP AND 
P1.ITCORMVP_NROITD = P2.ITCORMVP_NROITD AND 
P1.ITCORMVP_MODAPL = P2.ITCORMVP_MODAPL AND 
P1.ITCORMVP_CODAPL = P2.ITCORMVP_CODAPL AND 
P1.ITCORMVP_NROAPL = P2.ITCORMVP_NROAPL AND 
P1.ITCORMVP_ITMAPL = P2.ITCORMVP_ITMAPL AND 
P1.ITCORMVP_EXPAPL = P2.ITCORMVP_EXPAPL AND 
P1.ITCORMVP_ITDAPL = P2.ITCORMVP_ITDAPL 
/*'#Parte->FDS-412*/
AND 1 = CASE WHEN @FRA = 'S' THEN
							CASE WHEN P1.ITCORMVP_NCANPN = 'S' THEN 1 ELSE 0 END 
							ELSE 1
							END	

