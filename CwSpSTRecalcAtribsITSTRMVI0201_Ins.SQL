INSERT INTO cwOmProcs(cwOMProcName, cwOMProcType, cwOMMSSQLText, cwOMBaseTable, cwOMComments, cwOMProcOrder) VALUES ('CwSpSTRecalcAtribsITSTRMVI', 'P', 'CREATE Procedure CwSpSTRecalcAtribsITSTRMVI @TranId Varchar(10) as

-- Se hace en dos partes para un mejor seguimiento del stored, en caso de tener que revisar los cálculos
-- Pudo haberse hecho en una sola sentencia de update, utilizando el armado de la temporal, como tabla derivada para joinear en el update

-- Genera tabla temporal, auxiliar de la CORMVP, para rearmar la secuencia de numeracion de los atributos autonumerables
SELECT 
ITSTRMVI_SUCURS, ITSTRMVI_MODFOR, ITSTRMVI_CODFOR, ITSTRMVI_NROFOR, ITSTRMVI_NROITM, ITSTRMVI_NROITD, ITSTRMVI_NIVEXP, 
ITSTRMVI_DEPOSI, ITSTRMVI_SECTOR, ITSTRMVI_NSERIE, ITSTRMVI_NDESPA, ITSTRMVI_ENVASE, ITSTRMVI_NOTROS,
ITSTRMVI_TIPPRO,

CASE WHEN STTTPH_NUMPOR = ''C''	-- Numera por tipo y codigo de producto
		THEN 
			ROW_NUMBER() OVER(PARTITION BY ITSTRMVI_TIPPRO, ITSTRMVI_ARTCOD ORDER BY ITSTRMVI_TIPPRO, ITSTRMVI_ARTCOD, ITSTRMVI_NROITM, ITSTRMVI_NIVEXP, ITSTRMVI_NROITD ASC) 
			+ 
			CASE STTTPH_NUMAUT 
						WHEN ''NSERIE'' THEN
									(SELECT ISNULL(MAX(STRMVK_NSERIE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''NDESPA'' THEN
									(SELECT ISNULL(MAX(STRMVK_NDESPA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''ENVASE'' THEN
									(SELECT ISNULL(MAX(STRMVK_ENVASE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''NOTROS'' THEN
									(SELECT ISNULL(MAX(STRMVK_NOTROS),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''NATRIB'' THEN
									(SELECT ISNULL(MAX(STRMVK_NATRIB),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''NUBICA'' THEN
									(SELECT ISNULL(MAX(STRMVK_NUBICA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
						WHEN ''NESTAN'' THEN
									(SELECT ISNULL(MAX(STRMVK_NESTAN),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO AND STRMVK_ARTCOD = ITSTRMVI_ARTCOD) 
			END   
		ELSE	-- Numera por tipo de producto
			ROW_NUMBER() OVER(PARTITION BY ITSTRMVI_TIPPRO ORDER BY ITSTRMVI_TIPPRO, ITSTRMVI_ARTCOD, ITSTRMVI_NROITM, ITSTRMVI_NIVEXP, ITSTRMVI_NROITD ASC) 
			+ 
			CASE STTTPH_NUMAUT 
						WHEN ''NSERIE'' THEN
									(SELECT ISNULL(MAX(STRMVK_NSERIE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''NDESPA'' THEN
									(SELECT ISNULL(MAX(STRMVK_NDESPA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''ENVASE'' THEN
									(SELECT ISNULL(MAX(STRMVK_ENVASE),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''NOTROS'' THEN
									(SELECT ISNULL(MAX(STRMVK_NOTROS),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''NATRIB'' THEN
									(SELECT ISNULL(MAX(STRMVK_NATRIB),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''NUBICA'' THEN
									(SELECT ISNULL(MAX(STRMVK_NUBICA),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
						WHEN ''NESTAN'' THEN
									(SELECT ISNULL(MAX(STRMVK_NESTAN),0) FROM STRMVK WHERE STRMVK_TIPPRO = ITSTRMVI_TIPPRO) 
			END   			
END NEWATRIB  
INTO #ITSTRMVI_AUX
FROM ITSTRMVI, STTTPH
, STMPDH
WHERE 
ITSTRMVI_TRANID = @TRANID AND 
ITSTRMVI_TIPPRO = STTTPH_TIPPRO 
/*--''#Parte->KT-4 */
AND
ITSTRMVI_TIPPRO = STMPDH_TIPPRO AND 
ITSTRMVI_ARTCOD = STMPDH_ARTCOD AND
	1 =	CASE STTTPH_NUMAUT 
						WHEN ''NSERIE'' THEN
									CASE WHEN STMPDH_DEFSER <> ''N'' THEN 1 ELSE 0 END
						WHEN ''NDESPA'' THEN
									CASE WHEN STMPDH_DEFDES <> ''N'' THEN 1 ELSE 0 END
						WHEN ''ENVASE'' THEN
									CASE WHEN STMPDH_DEFENV <> ''N'' THEN 1 ELSE 0 END
						WHEN ''NOTROS'' THEN
									CASE WHEN STMPDH_DEFOTR <> ''N'' THEN 1 ELSE 0 END
						WHEN ''NATRIB'' THEN
									CASE WHEN STMPDH_DEFATR <> ''N'' THEN 1 ELSE 0 END
						WHEN ''NUBICA'' THEN
									CASE WHEN STMPDH_DEFUBI <> ''N'' THEN 1 ELSE 0 END
						WHEN ''NESTAN'' THEN
									CASE WHEN STMPDH_DEFEST <> ''N'' THEN 1 ELSE 0 END
		END   			
/*FIN ''#Parte->KT-4 */


--- Updetea la tabla intermedia de STRMVI (STRMVI), con los atributos autonumerables recalculados
UPDATE P1 
SET 
P1.ITSTRMVI_NSERIE = CASE WHEN STTTPH_NUMAUT = ''NSERIE'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NSERIE END,
P1.ITSTRMVI_NDESPA = CASE WHEN STTTPH_NUMAUT = ''NDESPA'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NDESPA END,
P1.ITSTRMVI_ENVASE = CASE WHEN STTTPH_NUMAUT = ''ENVASE'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_ENVASE END,
P1.ITSTRMVI_NOTROS = CASE WHEN STTTPH_NUMAUT = ''NOTROS'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NOTROS END,
P1.ITSTRMVI_NATRIB = CASE WHEN STTTPH_NUMAUT = ''NATRIB'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NATRIB END,
P1.ITSTRMVI_NUBICA = CASE WHEN STTTPH_NUMAUT = ''NUBICA'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NUBICA END,
P1.ITSTRMVI_NESTAN = CASE WHEN STTTPH_NUMAUT = ''NESTAN'' THEN REPLICATE('' '',30-(LEN(RTRIM(P2.NEWATRIB))))+LTRIM(RTRIM(P2.NEWATRIB)) ELSE P1.ITSTRMVI_NESTAN END
FROM ITSTRMVI P1, #ITSTRMVI_AUX P2, STTTPH
WHERE 
P1.ITSTRMVI_TRANID = @TRANID AND 
P1.ITSTRMVI_TIPPRO = STTTPH_TIPPRO AND
P1.ITSTRMVI_SUCURS = P2.ITSTRMVI_SUCURS AND 
P1.ITSTRMVI_MODFOR = P2.ITSTRMVI_MODFOR AND 
P1.ITSTRMVI_CODFOR = P2.ITSTRMVI_CODFOR AND 
P1.ITSTRMVI_NROFOR = P2.ITSTRMVI_NROFOR AND 
P1.ITSTRMVI_NROITM = P2.ITSTRMVI_NROITM AND 
P1.ITSTRMVI_NIVEXP = P2.ITSTRMVI_NIVEXP AND 
P1.ITSTRMVI_NROITD = P2.ITSTRMVI_NROITD AND 
P1.ITSTRMVI_DEPOSI = P2.ITSTRMVI_DEPOSI AND 
P1.ITSTRMVI_SECTOR = P2.ITSTRMVI_SECTOR 
', null, 'Rearma el atributo autonumerable, en la tabla intermedia de STRMVI. Modificado por #Parte->KT-4', 0)
