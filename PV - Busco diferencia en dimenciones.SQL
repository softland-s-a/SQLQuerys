declare @@CODDIM varchar(6)

select @@CODDIM = 'JUR'

select
PVRMVI_CODEMP,	PVRMVI_CODFOR,
	PVRMVI_NROFOR,
	PVRMVI_NROITM,
	(isnull(PVRMVI_IMPDEB,0) - isnull(PVRMVI_IMPHAB,0)) - ISNULL(sum(PVRMVG_IMPDEB) - sum(PVRMVG_IMPHAB),0) Diferencia,
	PVRMVI_CUENTA,
	PVRMVG_CUENTA,
	isnull(PVRMVI_IMPDEB,0) - isnull(PVRMVI_IMPHAB,0)  Item,
	(sum(PVRMVG_IMPDEB) - sum(PVRMVG_IMPHAB))  Apertura

from
	PVRMVI

	left outer join PVRMVG on
	PVRMVI_CODEMP = PVRMVG_CODEMP and
	PVRMVI_MODFOR = PVRMVG_MODFOR and
	PVRMVI_CODFOR = PVRMVG_CODFOR and
	PVRMVI_NROFOR = PVRMVG_NROFOR and
	PVRMVI_NROITM = PVRMVG_NROITM

	inner join cgmpch on
	PVRMVI_CUENTA = CGMPCH_CUENTA

	inner join cgmpci on
	CGMPCI_CUENTA = CGMPCH_CUENTA
where
	
	CGMPCI_IMPUTA = 'S' and
	PVRMVG_CODDIM = @@CODDIM and
	CGMPCI_CODDIM = @@CODDIM and
	CGMPCH_IMPUGS = 'S'

group by
	PVRMVI_CODEMP,
	PVRMVI_MODFOR,
	PVRMVI_CODFOR,
	PVRMVI_NROFOR,
	PVRMVI_NROITM,
	PVRMVI_CUENTA,
	PVRMVG_CUENTA,
	PVRMVI_IMPDEB,
	PVRMVI_IMPHAB

having
	(isnull(PVRMVI_IMPDEB,0) - isnull(PVRMVI_IMPHAB,0)) - ISNULL(sum(PVRMVG_IMPDEB) - sum(PVRMVG_IMPHAB),0) <> 0

order by
	isnull(PVRMVI_IMPDEB,0) - isnull(PVRMVI_IMPHAB,0) - (sum(PVRMVG_IMPDEB) - sum(PVRMVG_IMPHAB)) asc